version: '3.5'

# https://testdriven.io/blog/dockerizing-flask-with-postgres-gunicorn-and-nginx

services:
  app:
    image: azizsuf/deep-dark-sea-prod:latest
    container_name: deep_dark_sea_prod
    depends_on:
      - db
    command: #python -m flask --app /app/flaskr/main run --host=0.0.0.0
    ports:
      - 80:5000
    restart: unless-stopped
    networks:
      - app

  nginx:
    image: nginx:1.23.4-alpine
    container_name: nginx
    depends_on:
      - app
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - www-html:/var/www/html
      - ./nginx-conf.d:/etc/nginx/conf.d
      - etc-letsencrypt:/etc/letsencrypt
    networks:
      - app

  certbot:
    image: certbot/certbot
    container_name: certbot
    depends_on:
      - nginx
    volumes:
      - etc-letsencrypt:/etc/letsencrypt
      - www-html:/var/www/html
    command: certonly --webroot --webroot-path=/var/www/html --email aziz-sufyanov@mail.ru --agree-tos --no-eff-email -d deep-dark-sea.ru

  db:
    image: mysql:8.0.32
    container_name: mysql
    # NOTE: use of "mysql_native_password" is not recommended: https://dev.mysql.com/doc/refman/8.0/en/upgrading-from-previous-series.html#upgrade-caching-sha2-password
    # (this is just an example, not intended to be a production configuration)
    command: --default-authentication-plugin=mysql_native_password
    environment:
      MYSQL_ROOT_PASSWORD: example
    volumes:
      - ~/mysql_data:/var/lib/mysql
    restart: unless-stopped

  phpmyadmin:
    image: phpmyadmin:5.2.1
    restart: unless-stopped
    ports:
      - 8080:80
    environment:
      - PMA_ARBITRARY=1


volumes:
  www-html:
  dbfile:
  etc-letsencrypt:

networks:
  app:
    driver: bridge
